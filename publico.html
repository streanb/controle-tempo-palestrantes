<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Controle de Partidos</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: #f0f0f0; color: #222; }
    h2 { margin-top: 0; margin-bottom: 20px; }
    #grade { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px; }
    .cartao { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; }
    .cartao input[type="text"] { font-size:18px; font-weight:bold; width:100%; margin-bottom:12px; padding:6px 8px; border-radius:6px; border:1px solid #ccc; text-align:center; background:#fafafa; color:#333; }
    .botoes-cima { display:flex; justify-content:space-between; width:100%; margin-bottom:12px; gap:8px; }
    .botoes-cima input[type="number"] { width:80px; font-size:16px; padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fafafa; color:#333; text-align:center; }
    .botoes-cima button { flex:1; background:#e0e0e0; color:#000; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:background-color .3s; padding:8px 12px; font-size:14px; }
    .botoes-cima button:hover{ background:#d0d0d0; }
    .botoes-baixo { display:flex; justify-content:center; gap:15px; margin-top:10px; width:100%; }
    .botoes-baixo button { background:#444; color:#fff; border:none; border-radius:8px; font-size:18px; padding:10px 18px; cursor:pointer; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.1); transition:background-color .3s; min-width:70px; }
    .botoes-baixo button.pause { background:#666; }
    .botoes-baixo button.reset { background:#999; }
    .botoes-baixo button:hover { filter:brightness(1.1); }
    .tempo-display { margin-top:12px; font-size:2rem; font-weight:bold; color:#333; text-align:center; width:100%; }
    .top-controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; align-items:center; }
    .top-controls button { padding:8px 16px; font-weight:bold; border-radius:8px; border:none; cursor:pointer; background:#ccc; color:#000; transition:background-color .3s; }
    .top-controls button:hover{ background:#bbb; }
  </style>
</head>
<body>
  <h2>Administra√ß√£o do Tempo</h2>

  <div class="top-controls">
    <button onclick="adicionarPartido()">+ Adicionar Partido</button>
    <button onclick="resetarTudo()">üîÑ Reset Tudo</button>
  </div>

  <div id="grade"></div>

  <!-- Carregue firebase (se usar script tags compat√≠veis) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <script src="./firebase-config.js"></script> <!-- seu arquivo que inicializa e exporta db -->

  <script>
    /* Wrappers seguros para fun√ß√µes do database.
       Se o Firebase n√£o estiver definido/compat√≠vel no momento, essas vari√°veis
       ficar√£o undefined e o resto do app continuar√° funcionando sem travar.
    */
    let refFunc = null;
    let setFunc = null;
    let removeFunc = null;
    let onValueFunc = null;

    try {
      // Tentativa de suportar a API namespaced (firebase.database())
      if (window.firebase && typeof window.firebase.database === 'function') {
        const fbdb = window.firebase.database(); // objeto database (namespaced)
        refFunc = (path) => fbdb.ref(path);
        setFunc = (refOrPath, value) => {
          if (typeof refOrPath === 'string') return fbdb.ref(refOrPath).set(value);
          return refOrPath.set(value);
        };
        removeFunc = (refOrPath) => {
          if (typeof refOrPath === 'string') return fbdb.ref(refOrPath).remove();
          return refOrPath.remove();
        };
        onValueFunc = (refOrPath, cb) => {
          const r = (typeof refOrPath === 'string') ? fbdb.ref(refOrPath) : refOrPath;
          r.on('value', snapshot => cb(snapshot.val()));
        };
      }
    } catch (e) {
      // se falhar, deixa as fun√ß√µes nulas e evita crash do script
      console.warn('Firebase n√£o dispon√≠vel via namespaced API (ou ocorreu erro). Fun√ß√µes firebase desativadas.', e);
    }

    // Se o seu firebase-config.js define `db` modul ar (por exemplo export const db = ...),
    // voc√™ pode colocar db dispon√≠vel em window no firebase-config.js:
    // window.db = db;
    // Aqui fazemos uma tentativa adicional para suportar um `db` modular exposto globalmente:
    if (!refFunc && window.db) {
      try {
        // Se db for um objeto do SDK modular, ele n√£o ter√° .ref direto ‚Äî ent√£o
        // usamos as fun√ß√µes ref/set/remove importadas normalmente via m√≥dulo.
        // Para seguran√ßa, detectamos fun√ß√µes comuns:
        if (typeof window.ref === 'function' && typeof window.set === 'function' && typeof window.remove === 'function') {
          refFunc = (path) => window.ref(window.db, path);
          setFunc = (rOrPath, value) => {
            if (typeof rOrPath === 'string') return window.set(window.ref(window.db, rOrPath), value);
            return window.set(rOrPath, value);
          };
          removeFunc = (rOrPath) => {
            if (typeof rOrPath === 'string') return window.remove(window.ref(window.db, rOrPath));
            return window.remove(rOrPath);
          };
          onValueFunc = (r, cb) => {
            const rref = (typeof r === 'string') ? window.ref(window.db, r) : r;
            if (typeof window.onValue === 'function') {
              window.onValue(rref, snapshot => cb(snapshot));
            }
          };
        }
      } catch (e) {
        console.warn('Tentativa alternativa para modular db falhou', e);
      }
    }

    // Fun√ß√µes utilit√°rias
    function formatarTempo(seg) {
      const m = Math.floor(seg / 60).toString().padStart(2, '0');
      const s = (seg % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function atualizarFirebase(nome, tempo, rodando) {
      // usa wrapper se dispon√≠vel; se n√£o, apenas ignora (n√£o trava)
      if (!setFunc || !refFunc) return;
      try {
        setFunc(refFunc('tempos/' + nome), { tempoRestante: tempo, rodando: rodando });
      } catch (e) {
        console.warn('Falha ao atualizar Firebase', e);
      }
    }

    function atualizarNomeFirebase(nomeOriginal, novoNome) {
      if (!setFunc || !removeFunc || !refFunc) return;
      try {
        // remove nome antigo e grava o novo (estrutura simples)
        removeFunc(refFunc('nomes/' + nomeOriginal));
        setFunc(refFunc('nomes/' + novoNome), true);
      } catch (e) {
        console.warn('Falha ao atualizar nome no Firebase', e);
      }
    }

    // Estado local
    let partidos = [];
    const estados = {};

    function criarInterface() {
      const grade = document.getElementById('grade');
      grade.innerHTML = '';

      partidos.forEach((nome, i) => {
        // garante estado inicial caso n√£o exista
        if (!estados[nome]) estados[nome] = { tempo: 0, tempoInicial: 0, rodando: false, timer: null };

        const div = document.createElement('div');
        div.className = 'cartao';
        div.innerHTML = `
          <input type="text" id="nome-${i}" value="${nome}" onchange="salvarNome(${i})" />
          <div class="botoes-cima">
            <input type="number" id="min-${i}" placeholder="Minutos" min="0">
            <button onclick="setTempo(${i})">Definir Tempo</button>
            <button onclick="removerPartido(${i})">Remover</button>
          </div>
          <div class="botoes-baixo">
            <button onclick="play(${i})">‚ñ∂Ô∏è</button>
            <button class="pause" onclick="pause(${i})">‚è∏Ô∏è</button>
            <button class="reset" onclick="resetTempo(${i})">Reset</button>
          </div>
          <div class="tempo-display" id="tempo-${i}">
            ${formatarTempo(estados[nome].tempo)}
          </div>
        `;
        grade.appendChild(div);
      });
    }

    function salvarNome(i) {
      const novoNome = document.getElementById(`nome-${i}`).value.trim();
      const nomeAntigo = partidos[i];

      if (!novoNome) {
        alert("O nome n√£o pode ficar vazio!");
        document.getElementById(`nome-${i}`).value = nomeAntigo;
        return;
      }

      // atualiza array
      partidos[i] = novoNome;

      // migra estado (se existir)
      estados[novoNome] = estados[nomeAntigo] || { tempo:0, tempoInicial:0, rodando:false, timer:null };
      delete estados[nomeAntigo];

      // atualiza firebase (tolerante)
      atualizarNomeFirebase(nomeAntigo, novoNome);

      criarInterface();
    }

    function setTempo(i) {
      const nome = partidos[i];
      const min = parseInt(document.getElementById(`min-${i}`).value) || 0;
      if (!estados[nome]) estados[nome] = { tempo:0, tempoInicial:0, rodando:false, timer:null };

      estados[nome].tempoInicial = min * 60;
      estados[nome].tempo = estados[nome].tempoInicial;
      atualizarFirebase(nome, estados[nome].tempo, false);
      const el = document.getElementById(`tempo-${i}`);
      if (el) el.textContent = formatarTempo(estados[nome].tempo);
    }

    function play(i) {
      const nome = partidos[i];
      const estado = estados[nome];
      if (!estado) return;
      if (estado.rodando) return;
      if (estado.tempo <= 0) return; // n√£o inicia se sem tempo

      estado.rodando = true;
      atualizarFirebase(nome, estado.tempo, true);

      estado.timer = setInterval(() => {
        if (estado.tempo > 0) {
          estado.tempo--;
          atualizarFirebase(nome, estado.tempo, true);
          const el = document.getElementById(`tempo-${i}`);
          if (el) el.textContent = formatarTempo(estado.tempo);
        } else {
          clearInterval(estado.timer);
          estado.rodando = false;
          atualizarFirebase(nome, 0, false);
        }
      }, 1000);
    }

    function pause(i) {
      const nome = partidos[i];
      const estado = estados[nome];
      if (!estado) return;
      estado.rodando = false;
      clearInterval(estado.timer);
      atualizarFirebase(nome, estado.tempo, false);
    }

    function resetTempo(i) {
      const nome = partidos[i];
      const estado = estados[nome];
      if (!estado) return;
      estado.rodando = false;
      clearInterval(estado.timer);
      estado.tempo = estado.tempoInicial || 0;
      atualizarFirebase(nome, estado.tempo, false);
      const el = document.getElementById(`tempo-${i}`);
      if (el) el.textContent = formatarTempo(estado.tempo);
    }

    function adicionarPartido() {
      const novoNome = `Partido ${partidos.length + 1}`;
      partidos.push(novoNome);
      estados[novoNome] = { tempo: 0, tempoInicial: 0, rodando: false, timer: null };
      criarInterface();
      // opcional: registra no firebase nomes (se dispon√≠vel)
      if (setFunc && refFunc) {
        try { setFunc(refFunc('nomes/' + novoNome), true); } catch(e){ console.warn(e); }
      }
    }

    function removerPartido(i) {
      const nome = partidos[i];
      if (!nome) return;
      // cancela timer se houver
      if (estados[nome] && estados[nome].timer) clearInterval(estados[nome].timer);
      partidos.splice(i, 1);
      delete estados[nome];
      if (removeFunc && refFunc) {
        try {
          removeFunc(refFunc('tempos/' + nome));
          removeFunc(refFunc('nomes/' + nome));
        } catch(e) { console.warn(e); }
      }
      criarInterface();
    }

    function resetarTudo() {
      if (!confirm("Tem certeza que deseja limpar a visualiza√ß√£o p√∫blica?")) return;
      if (removeFunc && refFunc) {
        try {
          removeFunc(refFunc('tempos'));
          removeFunc(refFunc('nomes'));
        } catch(e) { console.warn(e); }
      }
      // cancelar timers e limpar estado
      partidasParaLimpar = Object.keys(estados);
      partidasParaLimpar.forEach(n => { if (estados[n].timer) clearInterval(estados[n].timer); });
      partidos = [];
      for (const k in estados) delete estados[k];
      document.getElementById('grade').innerHTML = '';
    }

    // Inicializa√ß√£o
    partidos = ["Partido 1", "Partido 2", "Partido 3"];
    partidos.forEach(nome => {
      estados[nome] = { tempo: 0, tempoInicial: 0, rodando: false, timer: null };
    });
    criarInterface();

    // exp√µe fun√ß√µes globalmente (para atributos onclick inline)
    window.salvarNome = salvarNome;
    window.setTempo = setTempo;
    window.play = play;
    window.pause = pause;
    window.resetTempo = resetTempo;
    window.adicionarPartido = adicionarPartido;
    window.removerPartido = removerPartido;
    window.resetarTudo = resetarTudo;

  </script>
</body>
</html>
