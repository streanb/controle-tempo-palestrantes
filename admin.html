<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Controle de Palestrantes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }

    h2, h3 {
      margin-top: 0;
    }

    #grade {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    .cartao {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .cartao input[type="text"] {
      font-size: 16px;
      font-weight: bold;
      width: 100%;
      margin-bottom: 8px;
    }

    .botoes-cima {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .botoes-cima input[type="number"] {
      width: 60px;
    }

    .botoes-cima button {
      padding: 4px 6px;
      font-size: 12px;
    }

    .botoes-baixo {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }

    .botoes-baixo button {
      font-size: 16px;
      padding: 6px 12px;
    }

    .top-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      align-items: center;
    }

    .top-controls input[type="text"] {
      font-size: 16px;
      padding: 6px;
      width: 300px;
    }

    .top-controls button {
      padding: 6px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Administra√ß√£o do Tempo</h2>

  <div class="top-controls">
    <input type="text" id="textoTopo" placeholder="Texto do topo da p√°gina p√∫blica" />
    <button onclick="atualizarTextoTopo()">Atualizar Texto do Topo</button>
    <button onclick="adicionarPalestrante()">+ Adicionar Palestrante</button>
    <button onclick="resetarTudo()">üîÑ Reset</button>
  </div>

  <div id="grade"></div>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      ref,
      set,
      onValue,
      remove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    let palestrantes = [];
    const estados = {};

    function formatarTempo(seg) {
      const m = Math.floor(seg / 60).toString().padStart(2, '0');
      const s = (seg % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function atualizarFirebase(nome, tempo, rodando) {
      set(ref(db, 'tempos/' + nome), {
        tempoRestante: tempo,
        rodando: rodando
      });
    }

    function atualizarNomeFirebase(nomeOriginal, novoNome) {
      // Remove nome antigo e adiciona novo no Firebase
      remove(ref(db, 'nomes/' + nomeOriginal));
      set(ref(db, 'nomes/' + novoNome), novoNome);
    }

    function atualizarTextoTopo() {
      const texto = document.getElementById('textoTopo').value;
      set(ref(db, 'textoTopo'), texto);
    }

    function criarInterface() {
      const grade = document.getElementById('grade');
      grade.innerHTML = '';

      palestrantes.forEach((nome, i) => {
        const div = document.createElement('div');
        div.className = 'cartao';
        div.innerHTML = `
          <input type="text" id="nome-${i}" value="${nome}" onchange="window.salvarNome(${i})" />
          <div class="botoes-cima">
            <input type="number" id="min-${i}" placeholder="Min" min="0">
            <button onclick="window.setTempo(${i})">Definir Tempo</button>
            <button onclick="window.removerPalestrante(${i})">Remover</button>
          </div>
          <div class="botoes-baixo">
            <button onclick="window.play(${i})">‚ñ∂Ô∏è</button>
            <button onclick="window.pause(${i})">‚è∏Ô∏è</button>
          </div>
          <div style="margin-top:8px; text-align:center;">
            <span id="tempo-${i}">00:00</span>
          </div>
        `;
        grade.appendChild(div);
      });
    }

    window.salvarNome = (i) => {
      const novoNome = document.getElementById(`nome-${i}`).value.trim();
      if(!novoNome) return alert("O nome n√£o pode ficar vazio.");

      const nomeAntigo = palestrantes[i];
      palestrantes[i] = novoNome;

      // Atualizar nomes no Firebase
      atualizarNomeFirebase(nomeAntigo, novoNome);

      // Atualizar estados para novo nome
      estados[novoNome] = estados[nomeAntigo];
      delete estados[nomeAntigo];

      criarInterface();
    };

    window.setTempo = (i) => {
      const nome = palestrantes[i];
      const min = parseInt(document.getElementById(`min-${i}`).value) || 0;
      estados[nome].tempo = min * 60;
      atualizarFirebase(nome, estados[nome].tempo, false);
      document.getElementById(`tempo-${i}`).textContent = formatarTempo(estados[nome].tempo);
    };

    window.play = (i) => {
      const nome = palestrantes[i];
      if (estados[nome].rodando) return;

      estados[nome].rodando = true;
      atualizarFirebase(nome, estados[nome].tempo, true);

      estados[nome].timer = setInterval(() => {
        if (estados[nome].tempo > 0) {
          estados[nome].tempo--;
          atualizarFirebase(nome, estados[nome].tempo, true);
          document.getElementById(`tempo-${i}`).textContent = formatarTempo(estados[nome].tempo);
        } else {
          clearInterval(estados[nome].timer);
          estados[nome].rodando = false;
          atualizarFirebase(nome, 0, false);
        }
      }, 1000);
    };

    window.pause = (i) => {
      const nome = palestrantes[i];
      estados[nome].rodando = false;
      clearInterval(estados[nome].timer);
      atualizarFirebase(nome, estados[nome].tempo, false);
    };

    window.adicionarPalestrante = () => {
      const novoNome = `Palestrante ${palestrantes.length + 1}`;
      palestrantes.push(novoNome);
      estados[novoNome] = { tempo: 0, rodando: false, timer: null };
      set(ref(db, 'nomes/' + novoNome), novoNome);
      criarInterface();
    };

    window.removerPalestrante = (i) => {
      const nome = palestrantes[i];
      palestrantes.splice(i, 1);
      delete estados[nome];
      remove(ref(db, 'tempos/' + nome));
      remove(ref(db, 'nomes/' + nome));
      criarInterface();
    };

    window.resetarTudo = () => {
      if (confirm("Tem certeza que deseja limpar a visualiza√ß√£o p√∫blica?")) {
        remove(ref(db, 'tempos'));
        remove(ref(db, 'nomes'));
        remove(ref(db, 'textoTopo'));
        palestrantes = [];
        document.getElementById('grade').innerHTML = '';
      }
    };

    // Inicializa√ß√£o
    palestrantes = ["Palestrante 1", "Palestrante 2", "Palestrante 3"];
    palestrantes.forEach(nome => {
      estados[nome] = { tempo: 0, rodando: false, timer: null };
      set(ref(db, 'nomes/' + nome), nome);
    });
    criarInterface();
  </script>
</body>
</html>
