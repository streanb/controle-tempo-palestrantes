<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Controle de Palestrantes</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .palestrante { margin-bottom: 20px; }
    button { margin-left: 5px; }
  </style>
</head>
<body>
  <h2>Administração do Tempo</h2>

  <label>Título Global:</label>
  <input type="text" id="titulo" placeholder="Título do evento" style="width: 300px;" />
  <button onclick="atualizarTitulo()">Atualizar Título</button>

  <h3>Controlo de Palestrantes</h3>
  <div id="container"></div>
  <button onclick="adicionarPalestrante()">+ Adicionar Palestrante</button>

  <script type="module">
    import { db } from './firebase-config.js';
    import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    let palestrantes = [];
    const estados = {};

    function formatarTempo(seg) {
      const m = Math.floor(seg / 60).toString().padStart(2, '0');
      const s = (seg % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function atualizarFirebaseTempo(nome, tempo, rodando) {
      set(ref(db, 'tempos/' + nome), {
        tempoRestante: tempo,
        rodando: rodando
      });
    }

    function atualizarTitulo() {
      const titulo = document.getElementById('titulo').value;
      set(ref(db, 'titulo'), titulo);
    }

    // Salva a lista de palestrantes no Firebase
    function salvarPalestrantesNoFirebase() {
      set(ref(db, 'palestrantes'), palestrantes);
    }

    // Salva os nomes personalizados no Firebase (objeto { nomeAntigo: nomeNovo })
    function salvarNomesNoFirebase() {
      const nomesObj = {};
      palestrantes.forEach(nome => {
        nomesObj[nome] = nome; // Pode ajustar para nomes customizados diferentes
      });
      set(ref(db, 'nomes'), nomesObj);
    }

    function criarInterface() {
      const container = document.getElementById('container');
      container.innerHTML = '';

      palestrantes.forEach((nome, i) => {
        if (!estados[nome]) estados[nome] = { tempo: 0, rodando: false, timer: null };

        const div = document.createElement('div');
        div.className = 'palestrante';
        div.innerHTML = `
          <input type="text" id="nome-${i}" value="${nome}" oninput="editarNome(${i})" />
          <input type="number" id="min-${i}" placeholder="Min" min="0" style="width: 60px;" />
          <button onclick="setTempo(${i})">Set</button>
          <span id="tempo-${i}">00:00</span>
          <button onclick="play(${i})">Play</button>
          <button onclick="pause(${i})">Pause</button>
          <button onclick="removerPalestrante(${i})">Remover</button>
        `;
        container.appendChild(div);

        // Atualiza display do tempo se houver no estado
        document.getElementById(`tempo-${i}`).textContent = formatarTempo(estados[nome].tempo);
      });
    }

    function editarNome(i) {
      const input = document.getElementById(`nome-${i}`);
      const nomeAntigo = palestrantes[i];
      const novoNome = input.value.trim() || nomeAntigo;

      if (novoNome === nomeAntigo) return; // sem mudança

      // Atualiza array
      palestrantes[i] = novoNome;

      // Atualiza estados para o novo nome, mantendo o tempo e rodando
      estados[novoNome] = estados[nomeAntigo];
      delete estados[nomeAntigo];

      // Atualiza Firebase: remove tempo antigo, cria tempo novo
      set(ref(db, 'tempos/' + nomeAntigo), null);
      atualizarFirebaseTempo(novoNome, estados[novoNome].tempo, estados[novoNome].rodando);

      salvarPalestrantesNoFirebase();
      salvarNomesNoFirebase();
      criarInterface();
    }

    window.setTempo = (i) => {
      const nome = palestrantes[i];
      const min = parseInt(document.getElementById(`min-${i}`).value) || 0;
      estados[nome].tempo = min * 60;
      atualizarFirebaseTempo(nome, estados[nome].tempo, false);
      document.getElementById(`tempo-${i}`).textContent = formatarTempo(estados[nome].tempo);
    };

    window.play = (i) => {
      const nome = palestrantes[i];
      if (estados[nome].rodando) return;

      estados[nome].rodando = true;
      atualizarFirebaseTempo(nome, estados[nome].tempo, true);

      estados[nome].timer = setInterval(() => {
        if (estados[nome].tempo > 0) {
          estados[nome].tempo--;
          atualizarFirebaseTempo(nome, estados[nome].tempo, true);
          document.getElementById(`tempo-${i}`).textContent = formatarTempo(estados[nome].tempo);
        } else {
          clearInterval(estados[nome].timer);
          estados[nome].rodando = false;
          atualizarFirebaseTempo(nome, 0, false);
        }
      }, 1000);
    };

    window.pause = (i) => {
      const nome = palestrantes[i];
      estados[nome].rodando = false;
      clearInterval(estados[nome].timer);
      atualizarFirebaseTempo(nome, estados[nome].tempo, false);
    };

    window.adicionarPalestrante = () => {
      const novoNome = `Palestrante ${palestrantes.length + 1}`;
      palestrantes.push(novoNome);
      estados[novoNome] = { tempo: 0, rodando: false, timer: null };
      salvarPalestrantesNoFirebase();
      salvarNomesNoFirebase();
      criarInterface();
    };

    window.removerPalestrante = (i) => {
      const nome = palestrantes[i];
      palestrantes.splice(i, 1);
      if (estados[nome]) {
        clearInterval(estados[nome].timer);
        delete estados[nome];
      }
      set(ref(db, 'tempos/' + nome), null); // remove do Firebase
      salvarPalestrantesNoFirebase();
      salvarNomesNoFirebase();
      criarInterface();
    };

    // Inicializa título do input lendo do Firebase
    onValue(ref(db, 'titulo'), (snapshot) => {
      const tituloFirebase = snapshot.val() || '';
      document.getElementById('titulo').value = tituloFirebase;
    });

    // Inicializa palestrantes lendo do Firebase
    onValue(ref(db, 'palestrantes'), (snapshot) => {
      palestrantes = snapshot.val() || [];
      // Sincroniza estados para os palestrantes novos
      palestrantes.forEach(nome => {
        if (!estados[nome]) estados[nome] = { tempo: 0, rodando: false, timer: null };
      });
      criarInterface();
    });

    // Inicializa nomes personalizados (atualmente só sincroniza, você pode usar para customizar se quiser)
    onValue(ref(db, 'nomes'), (snapshot) => {
      // Você pode querer atualizar inputs para nomes personalizados aqui, se quiser
      // Agora só mantemos os nomes do Firebase sincronizados
    });
  </script>
</body>
</html>
